<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js webgl - interactive cubes (gpu)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            font-family: Monospace, serif;
            background-color: #f0f0f0;
            margin: 0;
            overflow: hidden;
        }

        .info {
            position: absolute;
            background-color: black;
            opacity: 0.8;
            color: white;
            text-align: center;
            top: 0;
            width: 100%;
        }

        .info a {
            color: #00ffff;
        }
    </style>
</head>
<body>

<div class="info">
    <a href="http://threejs.org" target="_blank">three.js</a> webgl - conway's game of life 3d
</div>

<div id="container"></div>

<script src="js/three.js"></script>
<script src="js/TrackballControls.js"></script>
<script src="js/stats.min.js"></script>
<script src="game-of-life.js"></script>

<script>

var stats;
var camera, controls, scene, renderer;

var mouse = new THREE.Vector2();
var offset = new THREE.Vector3(10, 10, 10);

init();

var cubes = [];

var cells = stringPatternToCells(newCell(100, 100, 100), "\
        --xxxx--\n\
        -xxxxxx-\n\
        -xxxxxx-\n\
        --xxxx--\n\
");
cells = copyCellsInDepth(50, cells);

var gameOfLife = new GameOfLife(cells);
var showGame = function() {
    var defaultMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff, shading: THREE.FlatShading, vertexColors: THREE.VertexColors });

    cubes.forEach(function(cube) {
        scene.remove(cube);
    });
    cubes = [];

    gameOfLife.cells.forEach(function(cell) {
        var width = 10000;
        var height = 6000;
        var depth = 8000;
        var cellWidth = width / gameOfLife.width;
        var cellHeight = height / gameOfLife.height;
        var cellDepth = depth / gameOfLife.depth;

        var position = new THREE.Vector3(
                cell.x * cellWidth - width / 2,
                cell.y * cellHeight - height / 2,
                cell.z * cellDepth - depth / 2
        );
        var scale = new THREE.Vector3(cellWidth, cellHeight, cellDepth);
        var color = new THREE.Color(Math.random() * 0xffffff);
        var geom = new THREE.CubeGeometry(1, 1, 1);

        var cube = new THREE.Mesh(applyVertexColors(geom, color), defaultMaterial);
        cube.position.copy(position);
        cube.scale.copy(scale);

        cubes.push(cube);
        scene.add(cube);
    });
    gameOfLife.nextGeneration();

    setTimeout(showGame, 2000);
};
showGame();

animate();


function init() {
    var container = document.getElementById("container");

    camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 10000);
    camera.position.z = 8000;

    controls = new THREE.TrackballControls(camera);
    controls.rotateSpeed = 1.0;
    controls.zoomSpeed = 1.2;
    controls.panSpeed = 0.8;
    controls.noZoom = false;
    controls.noPan = false;
    controls.staticMoving = true;
    controls.dynamicDampingFactor = 0.3;

    scene = new THREE.Scene();

    scene.add(new THREE.AmbientLight(0x999999));

    var light = new THREE.SpotLight(0xffffff, 1.5);
    light.position.set(0, 500, 2000);
    scene.add(light);

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
    renderer.setClearColor(0xffffff, 1);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.sortObjects = false;
    renderer.domElement.addEventListener('mousemove', onMouseMove);
    container.appendChild(renderer.domElement);

    stats = new Stats();
    stats.domElement.style.position = 'absolute';
    stats.domElement.style.top = '0px';
    container.appendChild(stats.domElement);
}

function applyVertexColors(geometry, cube) {
    geometry.faces.forEach(function(f) {
        var n = ( f instanceof THREE.Face3 ) ? 3 : 4;
        for (var j = 0; j < n; j++) {
            f.vertexColors[ j ] = cube;
        }
    });
    return geometry;
}

function onMouseMove(e) {
    mouse.x = e.clientX;
    mouse.y = e.clientY;
}

function animate() {
    requestAnimationFrame(animate);
    render();
    stats.update();
}

function render() {
    controls.update();
    renderer.render(scene, camera);
}

</script>

</body>
</html>
